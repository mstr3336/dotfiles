#!/bin/bash


function mount_fs {
  if [ "$#" -lt 2 ]; then
    echo "Usage: <remote_mount> <local_mount>"

    exit 1
  fi

  local remote_mount="$1"
  local local_mount="$2"

  # Handle OSX compatibility
  local defer_permissions=""
  local allow_other=""
  # defer_permissions helps with OSX compat, & is only 
  # accepted as sshfs command on OSX
  if [[ "$(uname -s)" == "Darwin" ]]; then
    echo "running osx"
    defer_permissions="-o defer_permissions"
    allow_other="-o allow_other"
  fi

  local sshfs_general_opts="-o reconnect,ServerAliveInterval=15,ServerAliveCountMax=3"

  sshfs "$remote_mount" "$local_mount" \
    $sshfs_general_opts \
    $defer_permissions \
    $allow_other
}



# For Ubuntu 18.04
# Requires sshfs
# Requires UNIPASS and UNIKEY env vars to be set

which sshpass>/dev/null || echo "sshpass required"

source ~/.uni_auth
UNIKEY=$UNIKEY
SSHPASS=$UNIPASS

# sudo -s echo "${UNIPASS}" | sudo -s openconnect -b -u $UNIKEY --passwd-on-stdin https://vpn.sydney.edu.au  

# Setup shared connection
# You need to set ControlPath for the host

ssh -G jump | grep -q '^controlpath' || echo "no controlpath set for bastion"
ssh -G jhpc | grep -q '^controlpath' || echo "no controlpath set for host"

SSHPASS=$UNIPASS sshpass -e ssh -M -fN jump 

unset SSHPASS
unset UNIPASS

echo "Finished connecting to bastion"

sleep 1

# Background connect to jhpc before connecting with sshfs so that
# X connection is forwarded
ssh -M -fN jhpc

#ssh -v -fN "${UNIKEY}@hpc.sydney.edu.au" 

mount_fs jhpc:/project/STEMI/ ~/work/.project/STEMI
mount_fs jhpc:/project/ACS/ ~/work/.project/ACS
mount_fs jhpc:/rds/PRJ-STEMI/ ~/work/.rds/PRJ-STEMI
mount_fs jhpc:/rds/PRJ-ACS/ ~/work/.rds/PRJ-ACS


ssh -XYC jhpc
echo "Finsihed ssh-ing"
bash
